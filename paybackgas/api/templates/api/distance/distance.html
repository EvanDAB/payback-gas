{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block content %}

<form class="form-horizontal" action="">
        {% csrf_token %}
        {{ formset.management_form }}
        <div class='destination-container'>
            {% for form in formset %}
                <div class='destination'>
                    {{ form.destination }}
                </div>
            {% endfor %}
        </div>
        <input type="button" value="Add Destination" id="add_destination">
        <input type="button" value='Test Distance Traveled Button' id="test_dist_sum">
        <input type="submit" value='Submit' id="add_dist_sum">
    </form>

<script type='text/javascript' src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script>
    var total = $('#id_form' + '-TOTAL_FORMS').val();
    function cloneMore(selector, type) {
        var newElement = $(selector).clone(true);
        newElement.find(':input').each(function() {
            var name = $(this).attr('name').replace('-' + (total-1) + '-','-' + total + '-');
            console.log(total);
            console.log(name);
            var id = 'id_' + name;
            console.log(id);
            $(this).attr({'name': name, 'id': id}).val('').removeAttr('checked');
        });
        total ++;
        $('#id_' + type + '-TOTAL-FORMS').val(total);
        $(selector).after(newElement)
    }
    $('#add_destination').click(function() {
        cloneMore('div.destination:last', 'form');
    });
    //set header

    //takes in two strings and contactes them for ajax
    function determineDistance(orig, dest) {
        var apiKey = 'AIzaSyCNyQlXhkdhJQ4iczZl79qrzPf8EJXhzL8';
        var endpoint = 'https://maps.googleapis.com/maps/api/distancematrix/json';
        console.log(typeof orig);
        console.log(typeof dest);
        $.ajax({
            url: `${endpoint}?origins=${orig}&destinations=${dest}&key=${apiKey}&units=imperial`,
            contentType: 'application/json',
            dataType:'json',
            responseType:'application/json',
            xhrFields: {
                withCredentials: false
            },
            headers: {
                'Access-Control-Allow-Credentials' : true,
                'Access-Control-Allow-Origin':'*',
                'Access-Control-Allow-Methods':'GET',
                'Access-Control-Allow-Headers':'application/json',
            },
            success: function(response) {
                console.log(response);
            }  
        })
        
    }
    $('#test_dist_sum').click(function() {
        var element = $('div.destination-container').children().children();
        var destArr = [];
        for (var i=0; i < element.length; i ++) {
            var item = element[i].value
            destArr.push(item);
        };
        var destCopy = [...destArr];
        destCopy.pop();
        var origins = destCopy;
        destArr.shift();
        var destinations = destArr;
        var originParamStr = origins.join('|').replace(/, /gi, '+').replace(/ /gi, '+');
        var destinationParamStr = destinations.join('|').replace(/, /gi, '+').replace(/ /gi, '+');
        determineDistance(originParamStr, destinationParamStr);
        
    });
</script>
{% endblock %}